name: Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run quality check
      run: npm run quality-check
      env:
        NODE_ENV: test

    - name: Upload quality check results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-check-results
        path: |
          .next/
          node_modules/.cache/
        retention-days: 7

  security-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=moderate

    - name: Check for outdated dependencies
      run: npm outdated || true

  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Run type check
      run: npm run type-check

    - name: Run tests
      run: npm run test

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  database-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Install dependencies
      run: npm ci

    - name: Check Supabase configuration
      run: |
        echo "Checking Supabase configuration files..."
        if [ -f "supabase/config.toml" ]; then
          echo "✅ Supabase config.toml exists"
        else
          echo "❌ Supabase config.toml not found"
          exit 1
        fi
        
        if [ -d "supabase/migrations" ]; then
          echo "✅ Migrations directory exists"
          echo "Migration files:"
          ls -la supabase/migrations/ || echo "No migration files found"
        else
          echo "❌ Migrations directory not found"
          exit 1
        fi

    - name: Validate migration files
      run: |
        echo "Validating migration files..."
        if [ -d "supabase/migrations" ]; then
          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "✅ Found migration: $(basename "$file")"
              # Basic SQL syntax check (simple validation)
              if grep -q "CREATE\|ALTER\|DROP\|INSERT\|UPDATE\|DELETE" "$file"; then
                echo "  - Contains valid SQL keywords"
              else
                echo "  - Warning: No standard SQL keywords found"
              fi
            fi
          done
        fi 